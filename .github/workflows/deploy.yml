name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Validate required secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_ADMIN_IDS: ${{ secrets.TELEGRAM_ADMIN_IDS }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          missing=()
          [ -z "$CLOUDFLARE_API_TOKEN" ] && missing+=("CLOUDFLARE_API_TOKEN")
          [ -z "$CLOUDFLARE_ACCOUNT_ID" ] && missing+=("CLOUDFLARE_ACCOUNT_ID")
          [ -z "$TELEGRAM_BOT_TOKEN" ] && missing+=("TELEGRAM_BOT_TOKEN")
          [ -z "$TELEGRAM_ADMIN_IDS" ] && missing+=("TELEGRAM_ADMIN_IDS")
          [ -z "$D1_DATABASE_ID" ] && missing+=("D1_DATABASE_ID")
          [ -z "$KV_NAMESPACE_ID" ] && missing+=("KV_NAMESPACE_ID")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Missing required secrets: ${missing[*]}"
            echo "Please add the above secrets in Settings → Secrets and variables → Actions."
            exit 1
          fi

      - name: Generate wrangler.toml
        env:
          WORKER_NAME: ${{ secrets.WORKER_NAME }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          TELEGRAM_ADMIN_IDS: ${{ secrets.TELEGRAM_ADMIN_IDS }}
          MULTIUSER: ${{ secrets.MULTIUSER }}
          DEFAULT_INTERVAL: ${{ secrets.DEFAULT_INTERVAL }}
          MINIMAL_INTERVAL: ${{ secrets.MINIMAL_INTERVAL }}
          USER_SUB_LIMIT: ${{ secrets.USER_SUB_LIMIT }}
          CHANNEL_SUB_LIMIT: ${{ secrets.CHANNEL_SUB_LIMIT }}
        run: |
          cat > wrangler.toml << EOF
          name = "${WORKER_NAME:-tg-rss-worker}"
          main = "src/index.ts"
          compatibility_date = "2025-12-01"
          compatibility_flags = ["nodejs_compat"]

          [vars]
          TELEGRAM_ADMIN_IDS = "${TELEGRAM_ADMIN_IDS}"
          MULTIUSER = "${MULTIUSER:-false}"
          DEFAULT_INTERVAL = "${DEFAULT_INTERVAL:-5}"
          MINIMAL_INTERVAL = "${MINIMAL_INTERVAL:-5}"
          USER_SUB_LIMIT = "${USER_SUB_LIMIT:--1}"
          CHANNEL_SUB_LIMIT = "${CHANNEL_SUB_LIMIT:--1}"
          IMG_RELAY_SERVER = "https://rsstt-img-relay.rongrong.workers.dev/"
          IMAGES_WESERV_NL = "https://wsrv.nl/"

          [[d1_databases]]
          binding = "DB"
          database_name = "rss-db"
          database_id = "${D1_DATABASE_ID}"

          [[kv_namespaces]]
          binding = "KV"
          id = "${KV_NAMESPACE_ID}"
          EOF

      - name: Initialize D1 schema
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: pnpm exec wrangler d1 execute rss-db --remote --file=src/db/schema.sql

      - name: Deploy Worker
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WORKER_NAME: ${{ secrets.WORKER_NAME }}
        run: |
          deploy_output=$(pnpm exec wrangler deploy 2>&1) || {
            echo "$deploy_output"
            exit 1
          }
          echo "$deploy_output"

          worker_url=$(echo "$deploy_output" | grep -oP 'https://[^\s]+\.workers\.dev' | head -1)
          if [ -z "$worker_url" ]; then
            worker_name="${WORKER_NAME:-tg-rss-worker}"
            worker_url="https://${worker_name}.${CLOUDFLARE_ACCOUNT_ID}.workers.dev"
          fi
          echo "worker_url=${worker_url}" >> "$GITHUB_OUTPUT"
          echo "Worker URL: ${worker_url}"

      - name: Sanitize bot token
        id: bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          token="${TELEGRAM_BOT_TOKEN#bot}"
          token=$(echo -n "$token" | tr -d '[:space:]')
          echo "token=${token}" >> "$GITHUB_OUTPUT"

          # Validate token format: 123456:ABC-xyz
          if [[ ! "$token" =~ ^[0-9]+:.+$ ]]; then
            echo "::error::TELEGRAM_BOT_TOKEN format invalid. Expected format: 123456:ABC-DEF (without 'bot' prefix)."
            exit 1
          fi

          # Verify token with Telegram API
          me=$(curl -sS "https://api.telegram.org/bot${token}/getMe")
          echo "$me" | jq -e '.ok == true' > /dev/null || {
            echo "::error::TELEGRAM_BOT_TOKEN is invalid. Telegram API response: ${me}"
            exit 1
          }
          bot_name=$(echo "$me" | jq -r '.result.username')
          echo "Bot verified: @${bot_name}"

      - name: Set Worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ steps.bot.outputs.token }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
          TELEGRAPH_TOKEN: ${{ secrets.TELEGRAPH_TOKEN }}
        run: |
          json=$(jq -n \
            --arg bot_token "$TELEGRAM_BOT_TOKEN" \
            --arg webhook_secret "$TELEGRAM_WEBHOOK_SECRET" \
            --arg telegraph_token "$TELEGRAPH_TOKEN" \
            '{TELEGRAM_BOT_TOKEN: $bot_token} +
             (if $webhook_secret != "" then {TELEGRAM_WEBHOOK_SECRET: $webhook_secret} else {} end) +
             (if $telegraph_token != "" then {TELEGRAPH_TOKEN: $telegraph_token} else {} end)')
          echo "$json" | pnpm exec wrangler secret bulk

      - name: Set Telegram webhook
        env:
          TELEGRAM_BOT_TOKEN: ${{ steps.bot.outputs.token }}
          TELEGRAM_WEBHOOK_SECRET: ${{ secrets.TELEGRAM_WEBHOOK_SECRET }}
        run: |
          worker_url="${{ steps.deploy.outputs.worker_url }}"
          webhook_url="${worker_url}/webhook"
          echo "Setting webhook to: ${webhook_url}"

          if [ -n "$TELEGRAM_WEBHOOK_SECRET" ]; then
            payload=$(jq -n \
              --arg url "$webhook_url" \
              --arg secret "$TELEGRAM_WEBHOOK_SECRET" \
              '{url: $url, secret_token: $secret}')
          else
            payload=$(jq -n --arg url "$webhook_url" '{url: $url}')
          fi

          result=$(curl -sS -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook" \
            -H "Content-Type: application/json" \
            -d "$payload")
          echo "$result"
          echo "$result" | jq -e '.ok == true' > /dev/null || {
            echo "::error::Failed to set Telegram webhook. Response: ${result}"
            exit 1
          }

      - name: Set Telegram bot commands
        env:
          TELEGRAM_BOT_TOKEN: ${{ steps.bot.outputs.token }}
        run: |
          commands='[
            {"command": "sub", "description": "Subscribe"},
            {"command": "unsub", "description": "Unsubscribe"},
            {"command": "unsub_all", "description": "Unsubscribe from all subscriptions"},
            {"command": "list", "description": "Check the subscription list"},
            {"command": "set", "description": "Customize subscriptions"},
            {"command": "set_default", "description": "Customize default settings"},
            {"command": "import", "description": "Import subscriptions from an OPML file"},
            {"command": "export", "description": "Export subscriptions to an OPML file"},
            {"command": "activate_subs", "description": "Activate subscriptions"},
            {"command": "deactivate_subs", "description": "Deactivate subscriptions"},
            {"command": "version", "description": "Check the bot version"},
            {"command": "lang", "description": "Select a language"},
            {"command": "help", "description": "View help"}
          ]'

          result=$(curl -sS -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setMyCommands" \
            -H "Content-Type: application/json" \
            -d "{\"commands\": ${commands}}")
          echo "$result"
          echo "$result" | jq -e '.ok == true' > /dev/null || {
            echo "::error::Failed to set Telegram bot commands. Response: ${result}"
            exit 1
          }
